<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记忆闪卡 | 智能间隔重复学习系统</title>
    <!-- 引入必要的库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown渲染库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- SheetJS for Excel support -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 引入外部CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航栏 -->
        <nav class="navbar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="logo-text">
                    <h1>记忆闪卡</h1>
                    <p>基于间隔重复算法的智能学习系统</p>
                </div>
            </div>
            <div class="nav-actions">
                <button class="btn btn-outline" onclick="toggleSidebar()" id="sidebar-toggle">
                    <i class="fas fa-bars"></i> 切换侧栏
                </button>
                <button class="btn btn-outline" onclick="showExportModal()">
                    <i class="fas fa-download"></i> 导出
                </button>
                <button class="btn btn-primary" onclick="showImportModal()">
                    <i class="fas fa-upload"></i> 导入
                </button>
            </div>
        </nav>

        <!-- 主要内容 -->
        <div class="main-content" id="main-content">
            <!-- 左侧面板 -->
            <div class="left-panel sidebar" id="left-sidebar">
                <!-- 统计卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> 学习统计</h2>
                        <span class="btn-icon btn-secondary" onclick="loadCards()">
                            <i class="fas fa-sync-alt"></i>
                        </span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="today-count">0</div>
                            <div class="stat-label">今日复习</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-count">0</div>
                            <div class="stat-label">总卡片数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avg-repetition">0</div>
                            <div class="stat-label">平均重复次数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="mastered-count">0</div>
                            <div class="stat-label">已掌握</div>
                        </div>
                    </div>
                </div>

                <!-- 添加卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-plus-circle"></i> 添加新卡片</h2>
                    </div>
                    <form id="add-card-form">
                        <div class="form-group">
                            <label for="front" class="form-label">问题 / 正面</label>
                            <textarea id="front" class="form-textarea" placeholder="输入问题、单词或概念（支持Markdown）..." required></textarea>
                            <div class="markdown-preview hidden" id="front-preview"></div>
                            <button type="button" class="btn btn-outline btn-sm mt-1" onclick="togglePreview('front')">预览Markdown</button>
                        </div>
                        <div class="form-group">
                            <label for="back" class="form-label">答案 / 背面</label>
                            <textarea id="back" class="form-textarea" placeholder="输入答案、解释或定义（支持Markdown）..." required></textarea>
                            <div class="markdown-preview hidden" id="back-preview"></div>
                            <button type="button" class="btn btn-outline btn-sm mt-1" onclick="togglePreview('back')">预览Markdown</button>
                        </div>
                        <div class="form-group">
                            <label for="category" class="form-label">分类</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="category" class="form-input" placeholder="默认分类" list="category-list">
                                <datalist id="category-list">
                                    <!-- 分类选项将通过JavaScript动态添加 -->
                                </datalist>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-save"></i> 保存卡片
                        </button>
                    </form>
                </div>

                <!-- 使用指南 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-info-circle"></i> 使用指南</h2>
                    </div>
                    <ul style="padding-left: 1.25rem; font-size: 0.875rem; color: var(--gray-600); line-height: 1.7;">
                        <li class="mb-1"><strong>1. 界面操作</strong>
                            <ul style="padding-left: 1rem; margin-top: 0.25rem;">
                                <li>点击"切换侧栏"按钮可以隐藏/显示左侧面板</li>
                                <li>在移动端，侧栏默认隐藏，点击浮动按钮可快速添加卡片</li>
                                <li>点击卡片翻转查看答案</li>
                            </ul>
                        </li>
                        <li class="mb-1"><strong>2. 复习模式</strong>
                            <ul style="padding-left: 1rem; margin-top: 0.25rem;">
                                <li><strong>系统复习</strong>：自动安排的每日复习</li>
                                <li><strong>主动复习</strong>：提供5种模式：
                                    <ul style="padding-left: 1rem; margin-top: 0.25rem;">
                                        <li>列表无限循环：按顺序重复</li>
                                        <li>随机无限循环：随机顺序重复</li>
                                        <li>列表单次：按顺序一次</li>
                                        <li>随机单次：随机顺序一次</li>
                                        <li>薄弱项练习：专注记忆不牢的卡片</li>
                                    </ul>
                                </li>
                                <li>评分：没记住 / 模糊 / 记住了</li>
                            </ul>
                        </li>
                        <li class="mb-1"><strong>3. 内容格式</strong>
                            <ul style="padding-left: 1rem; margin-top: 0.25rem;">
                                <li>支持Markdown语法：**粗体**、*斜体*、`代码`等</li>
                                <li>数学公式：行内公式使用 $公式$，块级公式使用 $$公式$$</li>
                                <li>支持LaTeX语法：$\frac{1}{2}$、$E=mc^2$ 等</li>
                            </ul>
                        </li>
                        <li><strong>4. 卡片管理</strong>
                            <ul style="padding-left: 1rem; margin-top: 0.25rem;">
                                <li>卡片按分类组织，支持多级分类</li>
                                <li>支持批量导入/导出（CSV、TXT、Excel）</li>
                                <li>可选择特定卡片或分类进行复习</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 右侧面板 -->
            <div class="right-panel" id="right-panel">
                <!-- 复习区域 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-book-open"></i> 复习卡片</h2>
                        <div class="progress-header">
                            <span id="progress-text">0/0</span>
                            <span id="next-review-info"></span>
                        </div>
                    </div>

                    <div class="flashcard-container" id="flashcard-container">
                        <!-- 空状态 -->
                        <div class="empty-state" id="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <h3>没有需要复习的卡片</h3>
                            <p class="mt-1">添加新卡片或等待下次复习时间</p>
                            <button class="btn btn-primary mt-2" onclick="showReviewModeModal()" id="custom-review-btn">
                                <i class="fas fa-play"></i> 开始主动复习
                            </button>
                        </div>

                        <!-- 闪卡 -->
                        <div class="flashcard hidden" id="flashcard" onclick="toggleCard()">
                            <div class="flashcard-inner">
                                <div class="flashcard-front">
                                    <div class="card-content" id="card-front">
                                        <div class="content-inner">加载中...</div>
                                    </div>
                                    <div class="card-hint">点击卡片查看答案</div>
                                </div>
                                <div class="flashcard-back">
                                    <div class="card-content" id="card-back">
                                        <div class="content-inner">答案将显示在这里</div>
                                    </div>
                                    <div class="card-hint">根据记忆质量选择评分</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 复习模式指示器 -->
                    <div id="review-mode-indicator" class="hidden" style="text-align: center; margin-top: 1rem;">
                        <span class="btn btn-outline btn-sm">
                            <i class="fas fa-user-clock"></i> 主动复习模式
                        </span>
                    </div>

                    <!-- 评分按钮 -->
                    <div class="rating-buttons hidden" id="rating-buttons">
                        <button class="rating-btn rating-btn-forget" onclick="rateCard(0)">
                            <span class="rating-label">没记住</span>
                            <span class="rating-icon">
                                <i class="fas fa-times-circle"></i>
                            </span>
                        </button>
                        <button class="rating-btn rating-btn-blur" onclick="rateCard(2)">
                            <span class="rating-label">模糊</span>
                            <span class="rating-icon">
                                <i class="fas fa-question-circle"></i>
                            </span>
                        </button>
                        <button class="rating-btn rating-btn-remember" onclick="rateCard(4)">
                            <span class="rating-label">记住了</span>
                            <span class="rating-icon">
                                <i class="fas fa-check-circle"></i>
                            </span>
                        </button>
                    </div>

                    <!-- 主动复习导航按钮 -->
                    <div class="rating-buttons hidden" id="custom-review-buttons">
                        <button class="btn btn-secondary" onclick="prevCustomCard()">
                            <i class="fas fa-arrow-left"></i> 上一张
                        </button>
                        <button class="btn btn-success" onclick="nextCustomCard()">
                            下一张 <i class="fas fa-arrow-right"></i>
                        </button>
                        <button class="btn btn-outline" onclick="endCustomReview()">
                            <i class="fas fa-stop"></i> 结束复习
                        </button>
                    </div>

                    <!-- 进度条 -->
                    <div class="progress-container hidden" id="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- 卡片库 -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-folder"></i> 卡片库</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-icon btn-secondary" onclick="toggleSelectMode()" id="select-mode-btn" title="选择卡片">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="showReviewModeModal()" id="review-selected-btn" style="display: none;">
                                <i class="fas fa-play"></i> 复习选中卡片 (<span id="selected-count">0</span>)
                            </button>
                        </div>
                    </div>

                    <!-- 卡片选择状态 -->
                    <div class="review-selected-container hidden" id="review-selected-container">
                        <div class="text-center">
                            <p>已选择 <span class="selected-count" id="selected-count-display">0</span> 张卡片进行主动复习</p>
                            <button class="btn btn-primary mt-1" onclick="showReviewModeModal()">
                                <i class="fas fa-play"></i> 开始复习
                            </button>
                            <button class="btn btn-outline mt-1" onclick="clearSelection()">
                                <i class="fas fa-times"></i> 清除选择
                            </button>
                        </div>
                    </div>

                    <!-- 分类卡片库 -->
                    <div class="categories-container" id="categories-container">
                        <!-- 分类将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>

            <!-- 浮动按钮放在这里，确保它在网格布局内 -->
            <button class="floating-btn" id="floating-sidebar-btn" onclick="toggleSidebar()">
                <i class="fas fa-plus"></i>
                <span class="floating-tooltip">添加卡片</span>
            </button>
        </div>

        <!-- 编辑卡片模态框 -->
        <div class="modal hidden" id="edit-card-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-edit"></i> 编辑卡片</h2>
                    <button class="btn-icon btn-secondary" onclick="hideEditCardModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="edit-card-form">
                    <input type="hidden" id="edit-card-id">
                    <div class="form-group">
                        <label for="edit-front" class="form-label">问题 / 正面</label>
                        <textarea id="edit-front" class="form-textarea" placeholder="输入问题、单词或概念（支持Markdown）..." required></textarea>
                        <div class="markdown-preview hidden" id="edit-front-preview"></div>
                        <button type="button" class="btn btn-outline btn-sm mt-1" onclick="togglePreview('edit-front')">预览Markdown</button>
                    </div>
                    <div class="form-group">
                        <label for="edit-back" class="form-label">答案 / 背面</label>
                        <textarea id="edit-back" class="form-textarea" placeholder="输入答案、解释或定义（支持Markdown）..." required></textarea>
                        <div class="markdown-preview hidden" id="edit-back-preview"></div>
                        <button type="button" class="btn btn-outline btn-sm mt-1" onclick="togglePreview('edit-back')">预览Markdown</button>
                    </div>
                    <div class="form-group">
                        <label for="edit-category" class="form-label">分类</label>
                        <input type="text" id="edit-category" class="form-input" placeholder="默认分类" list="category-list">
                    </div>
                    <div class="mt-3" style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="hideEditCardModal()">取消</button>
                        <button type="submit" class="btn btn-primary">保存更改</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 复习模式选择模态框 -->
        <div class="modal hidden" id="review-mode-modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-cog"></i> 选择复习模式</h2>
                    <button class="btn-icon btn-secondary" onclick="hideReviewModeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="review-mode-options">
                    <div class="review-mode-option" onclick="selectReviewMode('list-infinite')">
                        <div class="mode-icon">
                            <i class="fas fa-infinity"></i>
                        </div>
                        <div class="mode-info">
                            <h4>列表无限循环</h4>
                            <p>按顺序重复复习所有卡片</p>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>

                    <div class="review-mode-option" onclick="selectReviewMode('random-infinite')">
                        <div class="mode-icon">
                            <i class="fas fa-random"></i>
                        </div>
                        <div class="mode-info">
                            <h4>随机无限循环</h4>
                            <p>随机顺序重复复习所有卡片</p>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>

                    <div class="review-mode-option" onclick="selectReviewMode('list-once')">
                        <div class="mode-icon">
                            <i class="fas fa-list-ol"></i>
                        </div>
                        <div class="mode-info">
                            <h4>列表单次</h4>
                            <p>按顺序复习一次所有卡片</p>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>

                    <div class="review-mode-option" onclick="selectReviewMode('random-once')">
                        <div class="mode-icon">
                            <i class="fas fa-random"></i>
                        </div>
                        <div class="mode-info">
                            <h4>随机单次</h4>
                            <p>随机顺序复习一次所有卡片</p>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>

                    <div class="review-mode-option" onclick="selectReviewMode('weak-only')">
                        <div class="mode-icon">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="mode-info">
                            <h4>薄弱项练习</h4>
                            <p>只复习记忆薄弱的卡片</p>
                        </div>
                        <div class="mode-check">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>

                <div class="mt-3 text-center">
                    <button class="btn btn-outline" onclick="hideReviewModeModal()">取消</button>
                    <button class="btn btn-primary" onclick="startCustomReviewWithMode()" id="start-review-btn">
                        开始复习
                    </button>
                </div>
            </div>
        </div>

        <!-- 导出模态框 -->
        <div class="modal hidden" id="export-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-download"></i> 导出卡片</h2>
                    <button class="btn-icon btn-secondary" onclick="hideExportModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="export-options">
                    <div class="export-option" onclick="exportCSV()">
                        <div class="export-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <h4>CSV格式</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-500);">标准表格格式，兼容Excel</p>
                    </div>

                    <div class="export-option" onclick="exportTXT()">
                        <div class="export-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h4>TXT格式</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-500);">纯文本格式，简单易读</p>
                    </div>

                    <div class="export-option" onclick="exportXLSX()">
                        <div class="export-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <h4>Excel格式</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-500);">Excel文件，完整数据</p>
                    </div>
                </div>

                <div class="format-help">
                    <h4>导出格式说明：</h4>
                    <ul>
                        <li><strong>CSV格式</strong>：包含卡片ID、正面、背面、分类、重复次数、间隔天数、易度因子、下次复习时间</li>
                        <li><strong>TXT格式</strong>：简单文本格式，每张卡片包含问题和答案，适合快速查看</li>
                        <li><strong>Excel格式</strong>：包含完整数据的工作簿文件，适合数据分析和备份</li>
                    </ul>
                </div>

                <div class="mt-3 text-center">
                    <button class="btn btn-outline" onclick="hideExportModal()">取消</button>
                </div>
            </div>
        </div>

        <!-- 导入模态框 -->
        <div class="modal hidden" id="import-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-file-import"></i> 导入卡片</h2>
                    <button class="btn-icon btn-secondary" onclick="hideImportModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="export-options">
                    <div class="export-option" onclick="document.getElementById('csv-file').click()">
                        <div class="export-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <h4>CSV格式</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-500);">点击选择CSV文件</p>
                    </div>

                    <div class="export-option" onclick="document.getElementById('txt-file').click()">
                        <div class="export-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h4>TXT格式</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-500);">点击选择TXT文件</p>
                    </div>

                    <div class="export-option" onclick="document.getElementById('xlsx-file').click()">
                        <div class="export-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <h4>Excel格式</h4>
                        <p style="font-size: 0.875rem; color: var(--gray-500);">点击选择Excel文件</p>
                    </div>
                </div>

                <div class="format-help">
                    <h4>导入格式说明：</h4>
                    <ul>
                        <li><strong>CSV格式</strong>：需要包含以下字段（第一行为标题行）：
                            <ul>
                                <li>front: 卡片正面内容（必需）</li>
                                <li>back: 卡片背面内容（必需）</li>
                                <li>category: 卡片分类（可选，默认为"默认分类"）</li>
                                <li>其他字段如repetition, interval, ease_factor, next_review会被忽略</li>
                            </ul>
                        </li>
                        <li><strong>TXT格式</strong>：支持以下格式：
                            <ul>
                                <li>每张卡片用空行分隔</li>
                                <li>正面以"Q:"或"问题:"开头</li>
                                <li>背面以"A:"或"答案:"开头</li>
                                <li>分类以"C:"或"分类:"开头（可选）</li>
                            </ul>
                        </li>
                        <li><strong>Excel格式</strong>：支持XLSX格式，第一行为标题行，字段同CSV格式</li>
                    </ul>
                    <p style="font-size: 0.875rem; color: var(--gray-600);">注意：导入时只会读取卡片内容，不会覆盖现有的记忆算法参数。</p>
                </div>

                <div class="mt-3 text-center">
                    <button class="btn btn-outline" onclick="hideImportModal()">取消</button>
                </div>
            </div>
        </div>

        <!-- 隐藏的文件输入 -->
        <input type="file" id="csv-file" accept=".csv" class="hidden" onchange="importFile('csv')">
        <input type="file" id="txt-file" accept=".txt" class="hidden" onchange="importFile('txt')">
        <input type="file" id="xlsx-file" accept=".xlsx,.xls" class="hidden" onchange="importFile('xlsx')">
    </div>

    <!-- 引入外部JavaScript -->
    <script src="/static/js/script.js"></script>
</body>
</html>
